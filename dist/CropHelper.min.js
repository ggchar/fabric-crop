import{fabric as e}from"fabric";export const initCrop=(t,l,o)=>{let n={id:"crop-rect",top:t.top,left:t.left,angle:t.angle,width:t.width*t.scaleX,height:t.height*t.scaleY,strokeUniform:!0,strokeWidth:0,cornerColor:"rgba(23,101,240,0.5)",cornerStrokeColor:"rgba(23,101,240,0.5)",padding:0,borderDashArray:[5,2],fill:"rgba(255, 255, 255, 1)",globalCompositeOperation:"overlay",lockRotation:!0,dirty:!1},r={id:"overlay-rect",top:t.top,left:t.left,angle:t.angle,width:t.width*t.scaleX,height:t.height*t.scaleY,selectable:!1,selection:!1,fill:"rgba(0, 0, 0, 0.5)",lockRotation:!0},i={icon:defalutApplyIcon,iconSize:24,x:.5,y:-.5,offsetY:-16,offsetX:-50,cursorStyle:"pointer",cornerSize:24},s={icon:defalutCancelIcon,iconSize:24,x:.5,y:-.5,offsetY:-16,offsetX:-20,cursorStyle:"pointer",cornerSize:24},a=loadFromURL;o&&(o.cropRect&&(n={...n,...o.cropRect}),o.overlayRect&&(r={...r,...o.overlayRect}),o.okButton&&(i={...i,...o.okButton}),o.cancelButton&&(s={...s,...o.cancelButton}),o.imageLoader&&(a=o.imageLoader));var c=new e.Rect(n);c.setControlVisible("mtr",!1);var d=new e.Rect(r);l.add(d),l.add(c),l.discardActiveObject(),l.setActiveObject(c),c.canvas||(c.canvas=l),createButton(c,"applyControl",()=>{applyCrop(c,t,l,a)},i),createButton(c,"cancelControl",()=>{cancelCrop(c,d,t,l)},s),l.renderAll(),c.originOCoords=c.oCoords,c.on("moving",function(e){let t=e.transform.target,l=t.originOCoords,o=getPointOnline(l.bl,l.br,t.width*t.scaleX),n=getPointOnline(l.tr,l.br,t.height*t.scaleY),r=l.tl,i=projectPointOntoSegment(l.tl,l.tr,o),s=projectPointOntoSegment(l.tl,l.bl,n),a=findIntersection(s,n,i,o),d={x:t.left,y:t.top},f=isPointOnSameSideOfLines(r,s,i,a,d),y=isPointOnSameSideOfLines(r,i,s,a,d);if(f>0||y>0){let g=t.top,p=t.left;if(1===f&&2===y)p=r.x,g=r.y;else if(2===f&&2===y)p=i.x,g=i.y;else if(2===f&&1===y)p=a.x,g=a.y;else if(1===f&&1===y)p=s.x,g=s.y;else if(0===f&&2===y){let A=projectPointOntoSegment(r,i,d);p=A.x,g=A.y}else if(2===f&&0===y){let u=projectPointOntoSegment(i,a,d);p=u.x,g=u.y}else if(0===f&&1===y){let b=projectPointOntoSegment(s,a,d);p=b.x,g=b.y}else if(1===f&&0===y){let m=projectPointOntoSegment(r,s,d);p=m.x,g=m.y}c.set({left:p,top:g})}}),c.on("scaling",function(e){let t=e.transform.target,l=e.transform.corner,o=c.originOCoords,n=c.oCoords;if("ml"===l||"mr"===l){if(e.transform.signX<0){let r=findIntersection(o.tl,o.bl,n.tl,n.tr),i=calculateDistance(r,n.tr),s=i/t.width;t.scaleX>s&&c.set({left:r.x,top:r.y,scaleX:s})}else{let a=findIntersection(o.tr,o.br,n.tl,n.tr),d=calculateDistance(a,n.tl),f=d/t.width;t.scaleX>f&&c.set({scaleX:f})}}else if("mt"===l||"mb"===l){if(e.transform.signY<0){let y=findIntersection(o.tl,o.tr,n.tl,n.bl),g=calculateDistance(y,n.bl),p=g/t.height;t.scaleY>p&&c.set({left:y.x,top:y.y,scaleY:p})}else{let A=findIntersection(o.bl,o.br,n.tl,n.bl),u=calculateDistance(A,n.tl),b=u/t.height;t.scaleY>b&&c.set({scaleY:b})}}else if(e.transform.signX<0){if(e.transform.signY<0){let m=distanceFromPointToLine(n.br,o.tl,o.bl)/t.width,x=distanceFromPointToLine(n.br,o.tl,o.tr)/t.height;if(t.scaleX>m&&t.scaleY>x)c.set({left:o.tl.x,top:o.tl.y,scaleX:m,scaleY:x});else if(t.scaleX>m){let h=findIntersection(o.tl,o.bl,n.tl,n.tr),$=calculateDistance(n.tr,n.br)/t.height;c.set({left:h.x,top:h.y,scaleX:m,scaleY:$})}else if(t.scaleY>x){let Y=findIntersection(o.tl,o.tr,n.tl,n.bl),C=calculateDistance(n.bl,n.br)/t.width;c.set({left:Y.x,top:Y.y,scaleX:C,scaleY:x})}}else{let X=distanceFromPointToLine(n.tr,o.tl,o.bl)/t.width,v=distanceFromPointToLine(n.tr,o.bl,o.br)/t.height;if(t.scaleX>X&&t.scaleY>v){let L=findIntersection(o.tl,o.bl,n.tl,n.tr);c.set({left:L.x,top:L.y,scaleX:X,scaleY:v})}else if(t.scaleX>X){let w=findIntersection(o.tl,o.bl,n.tl,n.tr);c.set({left:w.x,top:w.y,scaleX:X})}else t.scaleY>v&&c.set({scaleY:v})}}else if(e.transform.signY<0){let _=distanceFromPointToLine(n.bl,o.tr,o.br)/t.width,P=distanceFromPointToLine(n.bl,o.tl,o.tr)/t.height;if(t.scaleX>_&&t.scaleY>P){let S=findIntersection(o.tl,o.tr,n.tl,n.bl);c.set({left:S.x,top:S.y,scaleX:_,scaleY:P})}else if(t.scaleX>_)c.set({scaleX:_});else if(t.scaleY>P){let V=findIntersection(o.tl,o.tr,n.tl,n.bl);c.set({left:V.x,top:V.y,scaleY:P})}}else{let D=distanceFromPointToLine(n.tl,o.tr,o.br)/t.width,O=distanceFromPointToLine(n.tl,o.bl,o.br)/t.height;t.scaleX>D&&t.scaleY>O?c.set({scaleX:D,scaleY:O}):t.scaleX>D?c.set({scaleX:D}):t.scaleY>O&&c.set({scaleY:O})}}),c.on("deselected",function(){cancelCrop(c,d,t,l)})};let cancelCrop=(e,t,l,o)=>{delete e.controls.cancelControl,delete e.controls.applyControl,o.remove(t),o.remove(e),o.setActiveObject(l)};export const applyCrop=(e,t,l,o)=>{let n=Math.round(distanceFromPointToLine(e.oCoords.tl,t.oCoords.tl,t.oCoords.bl)-t.padding),r=Math.round(distanceFromPointToLine(e.oCoords.tl,t.oCoords.tl,t.oCoords.tr)-t.padding),i=Math.round(e.width*e.scaleX),s=Math.round(e.height*e.scaleY),a=Math.max(1/Math.min(t.scaleX,t.scaleY),1),c={drawingType:t.drawingType,angle:t.angle,id:t.id,name:t.name,top:e.top,left:e.left,scaleX:1/a,scaleY:1/a};t.set("angle",0);let d=t.toDataURL({multiplier:a,top:Math.abs(r),left:Math.abs(n),width:i,height:s});t.set("id",0),l.discardActiveObject(),l.remove(t),o(d,c).then(e=>{l.add(e),l.renderAll()})};let createButton=(t,l,o,n)=>{let r=document.createElement("img");function i(t,l){return function o(n,r,i,s,a){let c=l;n.save(),n.translate(r,i),n.rotate(e.util.degreesToRadians(a.angle)),n.drawImage(t,-c/2,-c/2,c,c),n.restore()}}r.src=n.icon,r.onload=()=>{t.canvas.requestRenderAll()},t.controls[l]=new e.Control({x:n.x,y:n.y,offsetY:n.offsetY,offsetX:n.offsetX,cursorStyle:n.cursorStyle,mouseUpHandler:o,render:i(r,n.iconSize),cornerSize:n.cornerSize})},findIntersection=(e,t,l,o)=>{let n=e.x,r=e.y,i=t.x,s=t.y,a=l.x,c=l.y,d=o.x,f=o.y;if(n===i){if(a===d)return null;let y=(f-c)/(d-a),g=c-y*a,p=n,A=y*p+g;return{x:p,y:A}}if(a===d){let u=(s-r)/(i-n),b=r-u*n,m=a,x=u*m+b;return{x:m,y:x}}if(r===s){if(c===f)return null;let h=(f-c)/(d-a),$=c-h*a,Y=r,C=(Y-$)/h;return{x:C,y:Y}}if(c===f){let X=(s-r)/(i-n),v=r-X*n,L=c,w=(L-v)/X;return{x:w,y:L}}let _=(s-r)/(i-n),P=r-_*n,S=(f-c)/(d-a),V=c-S*a;if(_===S)return null;let D=(V-P)/(_-S),O=_*D+P;return{x:D,y:O}},calculateDistance=(e,t)=>{let l=e.x,o=e.y,n=t.x,r=t.y;return Math.sqrt((n-l)**2+(r-o)**2)},distanceFromPointToLine=(e,t,l)=>{let o=t.x,n=t.y,r=l.x,i=l.y,s=e.x,a=e.y,c=i-n,d=o-r,f=r*n-o*i,y=Math.abs(c*s+d*a+f)/Math.sqrt(c*c+d*d);return y},getPointOnline=(e,t,l)=>{let o=l,n=e.x,r=e.y,i=t.x,s=t.y,a=Math.sqrt((i-n)**2+(s-r)**2),c=o/a,d=i+c*(n-i),f=s+c*(r-s);return{x:d,y:f}},subtract=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),projectPointOntoSegment=(e,t,l)=>{let o=subtract(t,e),n=subtract(l,e),r=o.x*o.x+o.y*o.y,i=n.x*o.x+n.y*o.y,s=Math.max(0,Math.min(1,i/r));return{x:e.x+s*o.x,y:e.y+s*o.y}},isPointOnSameSideOfLines=(e,t,l,o,n)=>{let r={x:t.x-e.x,y:t.y-e.y},i={x:o.x-l.x,y:o.y-l.y},s={x:n.x-e.x,y:n.y-e.y},a={x:n.x-l.x,y:n.y-l.y},c=r.x*s.y-r.y*s.x,d=i.x*a.y-i.y*a.x;return c>0&&d>0?1:c<0&&d<0?2:0},loadFromURL=(t,l)=>new Promise(o=>{let n=document.createElement("img");n.onload=()=>{o(new e.Image(n,l))},n.setAttribute("crossorigin","anonymous"),n.src=t}),defalutApplyIcon="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEvklEQVRYha2XW2xVVRCGv3+dAkoLsVykgQRIIEFCiVDL5YUgBqJGGl6UtFii3CsGgrwQQ+ITURNjolETilzlFvCBoAHaEBPUREoLGoT2CYTIA+USr6AY7Rqz9t7n0HNpaWnn9Jx0rdlr/f/MmjUzW9RTUBRNKlFZ+BkAehbZLGCGoQkyjQQLD91GXME4K9QM1mjY3aAyGYr2sXiXHOkJgceBjQa1wsZYMltos3hFpL0t6RBe73v5K90RcF3sEytNmyRdRmwiAacbcBIYgxGYXke65HBvd7emIAGZSkEnvOxdb77ErDvIwuKjT4cz7E2hJqHxPSSgMkkXDHuusNN6J2EPj5/l5C5KKn8QgcGCcx4/ps/IOdJhHcUyNQuy9nbZA3ccbHR/g6fF8I8K91VBAg5tlDG3707PQgzBkDU0+UlCH6bnomsoo1jSnXBnHyLe8iWdPu4kBB4BBt0nIymwGWfYzy6ZeMvTT+BpaYd109fzxaKj0AH8k5vXeC/Cpp6UpN/NrLjPoOkM1Q4vPvkSny86HE1/fe0b5h1+Giu2zKEnyWm4E1qg/gDnPviSiiUZ8CCnrp2KgdX54TDQoiLBXMvNrenxb3EFYCixG3tg+eLpi9m/cH9GVXfyNeqbtsYJvTMBWYiJZ5yHmXlnH8a/wtoZa5k3fh7cekDSDs/fgMXTFnOo6lA2+HdbYWSB9QFUNq0IbELeZndhy9wtbJ69OYrc8t3ltF5vhVHZ1yoj16G2spa9L+zNTC1vWMGuMzuhLAHPMTIuahoeVMPyNuyAiaUT4/8dnH75NOWjy+FmAUtuQHVFdRb4soZl7GruGvw+CSvJC41oVALVR6qp/zGu1UMGDaGptonJoybHJFLJs+1QM72Gg1UHM8tXN65hd/Pu2FvdgKfFxaedIwNiEnVH66g/vy3SFQ8opqW2hUmjnoisDkRqKmo4sPBAZu2qxlV82rStx+DhsJ0zdzVv2ieZqxTqvlzDRz98HJMYVMzZpS2MHTqO+ZPmZ4G/cuJVtp/Z/kC358gvRYhmJ83xuVfBkhT6GKw/to7QE6yvWEfJwBLaVrdGHknLysaVfNaypzeWx4nIuJiyKgYjqgs+ZclxFEHDhROUDS2jsqySgamBmchZ0bCSnWd29NbyUHlDDfgkpSqFI9jUKbTySRTFRI6dP0ZpcSmzR8+OVEuPL2VPsLyX4IkLwi1YVWTYPaEdQnVddkCWxMQw2HByQ3QrLv1xmX3n9sXg3XWphbAVtX0NZlwX9ZEvRzi4ZV32rokEK/9LyqyLb0pvwV1cA0JMTTFoc0mbcBt454GrfQI8JFyJZK63JVzR3wGTtYV6kPVe4HAXDF/er11RHr7aDcaC/RtjdhLDFjhSfyknOfYPcLoHYH4avBCBdm9+psP97eg/GlHQKZy25hnW2lmXV2RN1urNpjpS30e9W1/Bw9enfjJvlYY/lavvosrbZW/2FOY+CH54GCJhjVMKZ6ldeJsCnCvk0m7aDMO8f8N5V+682yd0775JnczLIKYjPHycpbyO0MEsb7YcWby2ENFCb8eyeJuQE5yFszO8rEy45yXNMfxUw0aZLDRrEvpTppuCNjO+NWh0pquh006uXfSaHr5ZAvwPfLzCeo8d28wAAAAASUVORK5CYII=",defalutCancelIcon="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEWElEQVRYhbWXzU9cVRjGf+fOnRFTbAdoYUCkHzDAkPrRj6QVoaUaUdPERGN01RhXJq5c6NalC/0DjBsXxrjQGDdNWtPEFmmZQtPEaGwLLTBgKTMDkQIpX3PvPeY9zJiRzh1uFZ7kJHe4z3ueh3ve9z3nqKnGAwREDXAaOAkcBCTwsXzoKpACbgH9wFngXpBpgxgQsQ+AM0BlQLM54FvgC2Dw/xj4DPg4oKgfvgQ+BFZKvbd8glqA37ZAXPA+cBM4GtSAfPJfgae3QLyAfcA14NRmBpqAIWDHFooX42fgUDkDl4DHt0m8gIuAXcrA58D+bRYX7AK+2WhA1ugj3xDbxltYwJuZNc9leTOzhluWB+8AR4oNfOLHVDJpNoMVjWIn2nBTY+ZvpXhuahS7o91wvZlMSV4RPjVxU40HJOEWZY5SLL24gKqOUvvTOUL1MdKHj7F2+waRfa1ox1kXD9msTYwQSTyjY0MDuNPTKtv7KnpuHvXEznImmuQLvOUnLvCWlwntqcWOt6AqK6lL9hNubmMtNYKyw2aIeDie0HUDfajKHUq4Vs0evOWlcuKCM2Lg5XKMUKyB1aGrpDu7tXZdbdVUU5e8TLiljVxq2IxI+0EdGxxQVjSqtOOSOd7F2vVrhOqf3MxAjyzBdeCwL0UpUBZrk7epONapY/19irCNN3efqab9KEvphskU1q6dSq/lyHSdZPVaknBTHLQHWpczcEcMzANlF6pgIicmnu+i7peLJsud0XF5q+3m/UrncmS7e1geHCASTFywKAaWAjUfpVD5LxFpSbDn/Fns5vWNzBkdJdt7mtzYMJG9cbQXSFywJDkQiGkmtCyTre7srMZ1/4mTdZf6N5msrKDiJlQMeEGYptRSw9htHbphbBi7Na68v+ZMLoTbWmkYH8GOJwxHuI9iYCyQuNR5a4eOJa9gVVWZNU8/e4TpQ0e1dj1THbGB9eoQbkATM1b+GOUvbtvkJkaJtHVQN5RUVlVUkXNMtufujuNMjCpJPp1ztLW7mtjQVcLxdhOzSScUpKz8FukLN32PyOEj1N/6Q0oNKbV01wlWh5KE97aasZLsV5nuHo3jaKsqSsPITSLPHcJJb3osvCwGvitLscPoBw/w5ufNz+yJU+viUmqea4Y8rw5esTLdLxqOd38evbSECoc3M/B14Uz4fb4lPwRptc69u9jNLYTqalm5dMEI6uI6z/cJR/rEqV7tpjPKGbuDXd+IdnJ+4gPACwUDCeCGH1NMuNksemWFUNNT4LoPl5qYCIVwJ/9EVVQQqq0tJy7oAfqKT8VfAe9t9s22CBeAXuO7yID0kZn8BWQ7IXv4bsAkVfGRTJc6tW4DXimIbzQg+D2/NtuFtzeWfal7QR9wHJjaQhPyH7+Wr7Z/we9mJPe5DqnTLRD/MV9l50u99DMgWADeBV4CfvgPwueA14E3gWk/0qNcz1uBN4DO/HMtUGh1LpDJb2xysxLDkk/lAfwNoz+a3zHVYDwAAAAASUVORK5CYII=";